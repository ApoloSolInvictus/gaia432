<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS GAIA | Planetary Synchronization</title>
    
    <!-- Librer铆as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { 
            background-color: #000; 
            color: #00ffff; 
            font-family: 'Rajdhani', sans-serif; 
            overflow: hidden; 
            margin: 0;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* UI Overlay */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .interactive { pointer-events: auto; }

        /* Holo Button */
        .holo-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .holo-btn:hover:not(:disabled) {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
            letter-spacing: 0.2em;
        }
        .holo-btn:disabled {
            opacity: 0.5; cursor: not-allowed; border-color: #444; background: rgba(0,0,0,0.5);
        }
        
        /* Animations */
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 10px;
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0), rgba(0, 255, 255, 0.5), rgba(0, 255, 255, 0));
            animation: scan 4s linear infinite;
            pointer-events: none; z-index: 5; opacity: 0.3;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }

        .pulse-text { animation: pulseText 2s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; text-shadow: 0 0 10px #00ffff; } }

        /* Canvas Container */
        #cosmos {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }
    </style>
</head>
<body>

    <div class="scan-line"></div>
    <canvas id="cosmos"></canvas>

    <!-- UI LAYER -->
    <div class="ui-layer flex flex-col justify-between p-6 md:p-12">
        
        <!-- HEADER -->
        <header class="flex justify-between items-start">
            <div class="interactive">
                <h1 class="font-orbitron text-4xl md:text-6xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-cyan-400 drop-shadow-[0_0_10px_rgba(0,255,255,0.8)]">
                    NEXUS GAIA
                </h1>
                <p class="text-sm md:text-base text-cyan-200/70 tracking-[0.5em] uppercase mt-2">Planetary Synchronization Grid</p>
                <div class="flex items-center gap-2 mt-4 text-xs font-mono text-cyan-500">
                    <span id="sys-status-dot" class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
                    <span id="sys-status-text">INITIALIZING...</span>
                </div>
            </div>
            
            <div class="text-right hidden md:block">
                <div class="font-mono text-xs text-cyan-500/60 uppercase mb-1">Schumann Resonance</div>
                <div class="text-3xl font-bold font-orbitron pulse-text">432.00 Hz</div>
                <div class="text-[10px] text-cyan-500/40">HARMONIC STABILITY: 99.8%</div>
            </div>
        </header>

        <!-- CENTER STATS -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none w-full">
            <div id="connection-status" class="opacity-0 transition duration-1000">
                <p class="text-cyan-100 text-lg font-light tracking-widest mb-2" id="status-message">LINKING NODES...</p>
                <div class="w-64 h-1 bg-cyan-900/50 mx-auto rounded-full overflow-hidden">
                    <div class="h-full bg-cyan-400 animate-[width_2s_ease-in-out_infinite]" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- FOOTER / CONTROLS -->
        <footer class="flex flex-col md:flex-row justify-between items-end gap-8">
            <div class="text-left font-mono text-xs text-cyan-600/60 w-64">
                <p>> PROTOCOL: AWAKENING</p>
                <p>> TARGET: 144,000 NODES</p>
                <p>> CURRENT: <span id="node-count" class="text-cyan-300 text-lg font-bold">...</span> ACTIVE</p>
            </div>

            <div class="interactive text-center">
                <button id="btn-sync" class="holo-btn px-10 py-6 rounded-none clip-path-polygon text-white font-orbitron font-bold text-xl uppercase tracking-widest group" disabled>
                    <span class="relative z-10 flex items-center gap-3" id="btn-content">
                        <i class="ph ph-circle-notch animate-spin"></i> CONNECTING
                    </span>
                </button>
                <p class="text-[10px] text-cyan-500/50 mt-4 uppercase tracking-widest">By Quantum Maximus & Apollo Sol Invictus</p>
            </div>
        </footer>
    </div>

    <!-- SCRIPT -->
    <script>
        // ==========================================
        // CONFIGURACIN FIREBASE (MEMORIA DE GAIA)
        // ==========================================
        // Cree un proyecto nuevo en Firebase y pegue sus llaves aqu铆
        const firebaseConfig = {
            apiKey: "AIzaSyBMEHoTnGVvnYWKDV-g1NKEfeS3leyaB7g", 
            authDomain: "gaia-168db.firebaseapp.com",
            projectId: "gaia-168db",
            storageBucket: "gaia-168db.firebasestorage.app",
            messagingSenderId: "940370360410",
            appId: "1:940370360410:web:458e3e64d306a0e4e84063"
        };

        // Inicializaci贸n
        let db;
        try {
            if (firebaseConfig.apiKey !== "PON_TU_API_KEY_AQUI") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log(" Nexus conectado a la memoria.");
            }
        } catch(e) { console.error("Error DB:", e); }

        // Elementos DOM
        const btnSync = document.getElementById('btn-sync');
        const btnContent = document.getElementById('btn-content');
        const nodeCountDisplay = document.getElementById('node-count');
        const statusDisplay = document.getElementById('connection-status');
        const statusMsg = document.getElementById('status-message');
        const sysDot = document.getElementById('sys-status-dot');
        const sysText = document.getElementById('sys-status-text');

        let userIP = null;
        let hasAnchored = false;

        // --- SISTEMA DE IDENTIFICACIN (IP) ---
        async function initSystem() {
            try {
                // 1. Obtener IP
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                userIP = ipData.ip;
                
                sysDot.classList.remove('bg-yellow-500');
                sysDot.classList.add('bg-green-500');
                sysText.innerText = `NODE ID: ${userIP}`;

                // 2. Verificar si ya vot贸 en Firebase
                if (db) {
                    checkStatus();
                    listenToGlobalCount();
                } else {
                    // Modo Demo si no hay Firebase
                    btnSync.disabled = false;
                    btnContent.innerHTML = '<i class="ph ph-planet text-2xl"></i> ANCHOR LIGHT';
                    nodeCountDisplay.innerText = "14,204";
                }

            } catch (e) {
                console.error("Error inicio:", e);
                sysText.innerText = "OFFLINE MODE";
                btnSync.disabled = false;
                btnContent.innerHTML = '<i class="ph ph-planet"></i> ANCHOR (OFFLINE)';
            }
        }

        // --- VERIFICAR ESTADO ---
        async function checkStatus() {
            const docRef = db.collection('nodes').doc(userIP);
            const doc = await docRef.get();
            
            if (doc.exists) {
                hasAnchored = true;
                lockButton();
                statusDisplay.classList.remove('opacity-0');
                statusMsg.innerText = "NODE ALREADY ACTIVE";
            } else {
                btnSync.disabled = false;
                btnContent.innerHTML = '<i class="ph ph-planet text-2xl group-hover:animate-spin"></i> ANCHOR LIGHT';
            }
        }

        // --- ESCUCHAR CONTADOR GLOBAL ---
        function listenToGlobalCount() {
            db.collection('system').doc('stats').onSnapshot((doc) => {
                if (doc.exists) {
                    const count = doc.data().count || 0;
                    // Animaci贸n de conteo
                    animateValue(nodeCountDisplay, parseInt(nodeCountDisplay.innerText.replace(/,/g, '')) || 0, count, 1000);
                }
            });
        }

        // --- ACCIN DE ANCLAJE ---
        btnSync.addEventListener('click', async () => {
            if (hasAnchored) return;
            
            // Efecto Visual
            btnContent.innerHTML = '<i class="ph ph-circle-notch animate-spin"></i> SYNCING...';
            
            // Sonido
            playTone();

            // Guardar en BD
            if (db && userIP) {
                try {
                    const batch = db.batch();
                    
                    // 1. Registrar IP
                    const nodeRef = db.collection('nodes').doc(userIP);
                    batch.set(nodeRef, { 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        agent: navigator.userAgent
                    });

                    // 2. Incrementar Contador
                    const statsRef = db.collection('system').doc('stats');
                    batch.update(statsRef, { 
                        count: firebase.firestore.FieldValue.increment(1) 
                    });

                    await batch.commit();
                    
                } catch (e) {
                    console.error("Error guardando:", e);
                    // Si falla (ej: stats no existe), crearlo
                    if (e.code === 'not-found') {
                        // L贸gica de fallback para inicializar la BD la primera vez
                    }
                }
            }

            // UI Final
            lockButton();
            statusDisplay.classList.remove('opacity-0');
            statusMsg.innerText = "FREQUENCY ANCHORED";
            
            // Activar part铆culas visuales
            activateParticles();
        });

        function lockButton() {
            btnSync.disabled = true;
            btnSync.classList.add('bg-cyan-500/20', 'border-cyan-500');
            btnContent.innerHTML = '<span class="text-cyan-300"><i class="ph ph-check-circle"></i> SYNC COMPLETE</span>';
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- SONIDO 432HZ ---
        function playTone() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(!AudioContext) return;
            const audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(432, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(864, audioCtx.currentTime + 1.5);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 1.5);
        }

        // --- VISUAL ENGINE (CANVAS) ---
        const canvas = document.getElementById('cosmos');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [], earthRadius;
        
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            earthRadius = Math.min(width, height) * 0.25;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() { this.reset(); this.angle = Math.random() * Math.PI * 2; this.speed = Math.random() * 0.002 + 0.001; }
            reset() { this.angle = Math.random() * Math.PI * 2; this.orbit = earthRadius + (Math.random() * 40 - 20); this.z = Math.random() * 2 - 1; this.active = false; }
            update() {
                this.angle += this.speed;
                this.x = width / 2 + Math.cos(this.angle) * this.orbit;
                this.y = height / 2 + Math.sin(this.angle) * this.orbit * 0.4; // Tilt effect
                this.z = Math.sin(this.angle);
                this.alpha = (this.z + 1) / 2 * 0.8 + 0.2;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.active ? 3 : 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.active ? '#ffffff' : '#00ffff';
                ctx.globalAlpha = this.alpha;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        for(let i=0; i<150; i++) particles.push(new Particle());

        function activateParticles() {
            particles.forEach(p => { if(Math.random() > 0.5) p.active = true; });
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, width, height);
            
            // Earth Core
            ctx.beginPath();
            ctx.arc(width/2, height/2, earthRadius * 0.8, 0, Math.PI * 2);
            ctx.fillStyle = '#001a2c';
            ctx.fill();
            ctx.strokeStyle = '#004466';
            ctx.lineWidth = 1;
            ctx.stroke();

            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }
        animate();
        
        // Start System
        initSystem();

    </script>
</body>
</html>
